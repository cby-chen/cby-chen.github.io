
<!DOCTYPE html>
<html lang="cn" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>二进制安装Kubernetes（k8s） v1.23.5 - 小陈运维</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="小陈运维,Github：https://github.com/cby-chen/Kubernetes/
1.23.3 和 1.23.4 和 1.23.5 文档以及安装包已生成。
后续尽可能第一时间更新新版本文,"> 
    <meta name="author" content="chenby"> 
    <link rel="alternative" href="atom.xml" title="小陈运维" type="application/atom+xml"> 
    <link rel="icon" href="/img/1.ico"> 
    
    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="二进制安装Kubernetes（k8s） v1.23.5 - 小陈运维"/>
    <meta name="twitter:description" content="小陈运维,Github：https://github.com/cby-chen/Kubernetes/
1.23.3 和 1.23.4 和 1.23.5 文档以及安装包已生成。
后续尽可能第一时间更新新版本文,"/>
    
    
    
    
    <meta property="og:site_name" content="小陈运维"/>
    <meta property="og:type" content="object"/>
    <meta property="og:title" content="二进制安装Kubernetes（k8s） v1.23.5 - 小陈运维"/>
    <meta property="og:description" content="小陈运维,Github：https://github.com/cby-chen/Kubernetes/
1.23.3 和 1.23.4 和 1.23.5 文档以及安装包已生成。
后续尽可能第一时间更新新版本文,"/>
    
<link rel="stylesheet" href="/css/diaspora.css">

<meta name="generator" content="Hexo 6.1.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">小陈运维</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://example.com"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">二进制安装Kubernetes（k8s） v1.23.5</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">二进制安装Kubernetes（k8s） v1.23.5</h1>
        <div class="stuff">
            <span>四月 02, 2022</span>
            

        </div>
        <div class="content markdown">
            <p>Github：<a target="_blank" rel="noopener" href="https://github.com/cby-chen/Kubernetes/">https://github.com/cby-chen/Kubernetes/</a></p>
<p>1.23.3 和 1.23.4 和 1.23.5 文档以及安装包已生成。</p>
<p>后续尽可能第一时间更新新版本文档</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cby-chen/Kubernetes/releases">https://github.com/cby-chen/Kubernetes/releases</a></p>
<h1 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h1><table>
<thead>
<tr>
<th>主机名称</th>
<th>IP地址</th>
<th>说明</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>Master01</td>
<td>192.168.1.61</td>
<td>master节点</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br />kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Master02</td>
<td>192.168.1.62</td>
<td>master节点</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br />kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Master03</td>
<td>192.168.1.63</td>
<td>master节点</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br />kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Node01</td>
<td>192.168.1.64</td>
<td>node节点</td>
<td>kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Node02</td>
<td>192.168.1.65</td>
<td>node节点</td>
<td>kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Node03</td>
<td>192.168.1.66</td>
<td>node节点</td>
<td>kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Node04</td>
<td>192.168.1.67</td>
<td>node节点</td>
<td>kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Node05</td>
<td>192.168.1.68</td>
<td>node节点</td>
<td>kubelet、kube-proxy、nfs-client</td>
</tr>
<tr>
<td>Lb01</td>
<td>192.168.1.57</td>
<td>Lb01节点</td>
<td>haproxy、keepalived</td>
</tr>
<tr>
<td>Lb02</td>
<td>192.168.1.58</td>
<td>Lb02节点</td>
<td>haproxy、keepalived</td>
</tr>
<tr>
<td></td>
<td>192.168.1.59</td>
<td>VIP</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">软件</th>
<th align="left">版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">内核</td>
<td align="left">5.17.1-1.el8.elrepo.x86_64</td>
</tr>
<tr>
<td align="left">CentOS 8</td>
<td align="left">v8</td>
</tr>
<tr>
<td align="left">kube-apiserver、kube-controller-manager、kube-scheduler、kubelet、kube-proxy</td>
<td align="left">v1.23.5</td>
</tr>
<tr>
<td align="left">etcd</td>
<td align="left">v3.5.2</td>
</tr>
<tr>
<td align="left">docker-ce</td>
<td align="left">v20.10.14</td>
</tr>
<tr>
<td align="left">containerd</td>
<td align="left">v1.5.11</td>
</tr>
<tr>
<td align="left">cfssl</td>
<td align="left">v1.6.1</td>
</tr>
<tr>
<td align="left">cni</td>
<td align="left">v1.1.1</td>
</tr>
<tr>
<td align="left">crictl</td>
<td align="left">v1.23.0</td>
</tr>
<tr>
<td align="left">haproxy</td>
<td align="left">v1.8.27</td>
</tr>
<tr>
<td align="left">keepalived</td>
<td align="left">v2.1.5</td>
</tr>
</tbody></table>
<p>网段</p>
<p>物理主机：192.168.1.0&#x2F;24</p>
<p>service：10.96.0.0&#x2F;12</p>
<p>pod：172.16.0.0&#x2F;12</p>
<p>如果有条件建议k8s集群与etcd集群分开安装</p>
<h2 id="1-1-k8s基础系统环境配置"><a href="#1-1-k8s基础系统环境配置" class="headerlink" title="1.1.k8s基础系统环境配置"></a>1.1.k8s基础系统环境配置</h2><h3 id="1-2-配置IP"><a href="#1-2-配置IP" class="headerlink" title="1.2.配置IP"></a>1.2.配置IP</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.1.161 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.61/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.167 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.62/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.137 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.63/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.152 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.64/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.198 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.65/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.166 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.66/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.171 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.67/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.159 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.68/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.125 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.57/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br><span class="line">ssh root@192.168.1.122 &quot;nmcli con mod ens18 ipv4.addresses 192.168.1.58/24; nmcli con mod ens18 ipv4.gateway 192.168.1.99; nmcli con mod ens18 ipv4.method manual; nmcli con mod ens18 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up ens18&quot;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-设置主机名"><a href="#1-3-设置主机名" class="headerlink" title="1.3.设置主机名"></a>1.3.设置主机名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master01</span><br><span class="line">hostnamectl set-hostname k8s-master02</span><br><span class="line">hostnamectl set-hostname k8s-master03</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br><span class="line">hostnamectl set-hostname k8s-node02</span><br><span class="line">hostnamectl set-hostname k8s-node03</span><br><span class="line">hostnamectl set-hostname k8s-node04</span><br><span class="line">hostnamectl set-hostname k8s-node05</span><br><span class="line">hostnamectl set-hostname lb01</span><br><span class="line">hostnamectl set-hostname lb02</span><br></pre></td></tr></table></figure>

<h3 id="1-4-配置yum源"><a href="#1-4-配置yum源" class="headerlink" title="1.4.配置yum源"></a>1.4.配置yum源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; \</span><br><span class="line">         -e &#x27;s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=http://192.168.1.123/centos|g&#x27; \</span><br><span class="line">         -i.bak \</span><br><span class="line">         /etc/yum.repos.d/CentOS-*.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; -e &#x27;s|^#baseurl=http://mirror.centos.org/\$contentdir|baseurl=http://192.168.1.123/centos|g&#x27; -i.bak  /etc/yum.repos.d/CentOS-*.repo</span><br></pre></td></tr></table></figure>

<h3 id="1-5-安装一些必备工具"><a href="#1-5-安装一些必备工具" class="headerlink" title="1.5.安装一些必备工具"></a>1.5.安装一些必备工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget jq psmisc vim net-tools  telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl -y</span><br></pre></td></tr></table></figure>

<h3 id="1-6-安装docker工具-lb除外"><a href="#1-6-安装docker工具-lb除外" class="headerlink" title="1.6.安装docker工具 (lb除外)"></a>1.6.安装docker工具 (lb除外)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></table></figure>

<h3 id="1-7-关闭防火墙"><a href="#1-7-关闭防火墙" class="headerlink" title="1.7.关闭防火墙"></a>1.7.关闭防火墙</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld</span><br></pre></td></tr></table></figure>

<h3 id="1-8-关闭SELinux"><a href="#1-8-关闭SELinux" class="headerlink" title="1.8.关闭SELinux"></a>1.8.关闭SELinux</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<h3 id="1-9-关闭交换分区"><a href="#1-9-关闭交换分区" class="headerlink" title="1.9.关闭交换分区"></a>1.9.关闭交换分区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">cat /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/dev/mapper/centos-swap swap                    swap    defaults        0 0</span></span><br></pre></td></tr></table></figure>

<h3 id="1-10-关闭NetworkManager-并启用-network-lb除外"><a href="#1-10-关闭NetworkManager-并启用-network-lb除外" class="headerlink" title="1.10.关闭NetworkManager 并启用 network (lb除外)"></a>1.10.关闭NetworkManager 并启用 network (lb除外)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now NetworkManager</span><br><span class="line">systemctl start network &amp;&amp; systemctl enable network</span><br></pre></td></tr></table></figure>

<h3 id="1-11-进行时间同步-lb除外"><a href="#1-11-进行时间同步-lb除外" class="headerlink" title="1.11.进行时间同步 (lb除外)"></a>1.11.进行时间同步 (lb除外)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">服务端</span><br><span class="line"></span><br><span class="line">yum install chrony -y</span><br><span class="line">cat &gt; /etc/chrony.conf &lt;&lt; EOF </span><br><span class="line">pool ntp.aliyun.com iburst</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">makestep 1.0 3</span><br><span class="line">rtcsync</span><br><span class="line">allow 192.168.1.0/24</span><br><span class="line">local stratum 10</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line">leapsectz right/UTC</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line"></span><br><span class="line">客户端</span><br><span class="line"></span><br><span class="line">yum install chrony -y</span><br><span class="line">vim /etc/chrony.conf</span><br><span class="line">cat /etc/chrony.conf | grep -v  &quot;^#&quot; | grep -v &quot;^$&quot;</span><br><span class="line">pool 192.168.1.61 iburst</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">makestep 1.0 3</span><br><span class="line">rtcsync</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line">leapsectz right/UTC</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd ; systemctl enable chronyd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum install chrony -y ; sed -i &quot;s#2.centos.pool.ntp.org#192.168.1.61#g&quot; /etc/chrony.conf ; systemctl restart chronyd ; systemctl enable chronyd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用客户端进行验证</span><br><span class="line"></span><br><span class="line">chronyc sources -v</span><br></pre></td></tr></table></figure>

<h3 id="1-12-配置ulimit"><a href="#1-12-配置ulimit" class="headerlink" title="1.12.配置ulimit"></a>1.12.配置ulimit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ulimit -SHn 65535</span><br><span class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* seft memlock unlimited</span><br><span class="line">* hard memlock unlimitedd</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="1-13-配置免密登录"><a href="#1-13-配置免密登录" class="headerlink" title="1.13.配置免密登录"></a>1.13.配置免密登录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y sshpass</span><br><span class="line">ssh-keygen -f /root/.ssh/id_rsa -P &#x27;&#x27;</span><br><span class="line">export IP=&quot;192.168.1.61 192.168.1.62 192.168.1.63 192.168.1.64 192.168.1.65 192.168.1.66 192.168.1.67 192.168.1.68 192.168.1.57 192.168.1.58&quot;</span><br><span class="line">export SSHPASS=123123</span><br><span class="line">for HOST in $IP;do</span><br><span class="line">     sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="1-14-添加启用源-lb除外"><a href="#1-14-添加启用源-lb除外" class="headerlink" title="1.14.添加启用源 (lb除外)"></a>1.14.添加启用源 (lb除外)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">为 RHEL-8或 CentOS-8配置源</span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line">为 RHEL-7 SL-7 或 CentOS-7 安装 ELRepo </span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line">查看可用安装包</span><br><span class="line">yum  --disablerepo=&quot;*&quot;  --enablerepo=&quot;elrepo-kernel&quot;  list  available</span><br></pre></td></tr></table></figure>

<h3 id="1-15-升级内核至4-18版本以上-lb除外"><a href="#1-15-升级内核至4-18版本以上-lb除外" class="headerlink" title="1.15.升级内核至4.18版本以上 (lb除外)"></a>1.15.升级内核至4.18版本以上 (lb除外)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">安装最新的内核</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我这里选择的是稳定版kernel-ml   如需更新长期维护版本kernel-lt</span>  </span><br><span class="line">yum  --enablerepo=elrepo-kernel  install  kernel-ml</span><br><span class="line"></span><br><span class="line">查看已安装那些内核</span><br><span class="line">rpm -qa | grep kernel</span><br><span class="line">kernel-core-4.18.0-358.el8.x86_64</span><br><span class="line">kernel-tools-4.18.0-358.el8.x86_64</span><br><span class="line">kernel-ml-core-5.16.7-1.el8.elrepo.x86_64</span><br><span class="line">kernel-ml-5.16.7-1.el8.elrepo.x86_64</span><br><span class="line">kernel-modules-4.18.0-358.el8.x86_64</span><br><span class="line">kernel-4.18.0-358.el8.x86_64</span><br><span class="line">kernel-tools-libs-4.18.0-358.el8.x86_64</span><br><span class="line">kernel-ml-modules-5.16.7-1.el8.elrepo.x86_64</span><br><span class="line"></span><br><span class="line">查看默认内核</span><br><span class="line">grubby --default-kernel</span><br><span class="line">/boot/vmlinuz-5.16.7-1.el8.elrepo.x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">若不是最新的使用命令设置</span><br><span class="line">grubby --set-default /boot/vmlinuz-「您的内核版本」.x86_64</span><br><span class="line"></span><br><span class="line">重启生效</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">整合命令为：</span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y ; yum  --disablerepo=&quot;*&quot;  --enablerepo=&quot;elrepo-kernel&quot;  list  available -y ; yum  --enablerepo=elrepo-kernel  install  kernel-ml -y ; grubby --default-kernel ; reboot</span><br></pre></td></tr></table></figure>

<h3 id="1-16-安装ipvsadm-lb除外"><a href="#1-16-安装ipvsadm-lb除外" class="headerlink" title="1.16.安装ipvsadm (lb除外)"></a>1.16.安装ipvsadm (lb除外)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">yum install ipvsadm ipset sysstat conntrack libseccomp -y</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF </span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart systemd-modules-load.service</span><br><span class="line"></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">ip_vs_sh               16384  0</span><br><span class="line">ip_vs_wrr              16384  0</span><br><span class="line">ip_vs_rr               16384  0</span><br><span class="line">ip_vs                 180224  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span><br><span class="line">nf_conntrack          176128  1 ip_vs</span><br><span class="line">nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span><br><span class="line">nf_defrag_ipv4         16384  1 nf_conntrack</span><br><span class="line">libcrc32c              16384  3 nf_conntrack,xfs,ip_vs</span><br></pre></td></tr></table></figure>

<h3 id="1-17-修改内核参数-lb除外"><a href="#1-17-修改内核参数-lb除外" class="headerlink" title="1.17.修改内核参数 (lb除外)"></a>1.17.修改内核参数 (lb除外)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.ip_conntrack_max = 65536</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<h3 id="1-18-所有节点配置hosts本地解析"><a href="#1-18-所有节点配置hosts本地解析" class="headerlink" title="1.18.所有节点配置hosts本地解析"></a>1.18.所有节点配置hosts本地解析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.1.61 k8s-master01</span><br><span class="line">192.168.1.62 k8s-master02</span><br><span class="line">192.168.1.63 k8s-master03</span><br><span class="line">192.168.1.64 k8s-node01</span><br><span class="line">192.168.1.65 k8s-node02</span><br><span class="line">192.168.1.66 k8s-node03</span><br><span class="line">192.168.1.67 k8s-node04</span><br><span class="line">192.168.1.68 k8s-node05</span><br><span class="line">192.168.1.57 lb01</span><br><span class="line">192.168.1.58 lb02</span><br><span class="line">192.168.1.59 lb-vip</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h1 id="2-k8s基本组件安装"><a href="#2-k8s基本组件安装" class="headerlink" title="2.k8s基本组件安装"></a>2.k8s基本组件安装</h1><h2 id="2-1-所有k8s节点安装Containerd作为Runtime"><a href="#2-1-所有k8s节点安装Containerd作为Runtime" class="headerlink" title="2.1.所有k8s节点安装Containerd作为Runtime"></a>2.1.所有k8s节点安装Containerd作为Runtime</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install containerd -y</span><br></pre></td></tr></table></figure>

<h3 id="2-1-1配置Containerd所需的模块"><a href="#2-1-1配置Containerd所需的模块" class="headerlink" title="2.1.1配置Containerd所需的模块"></a>2.1.1配置Containerd所需的模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2加载模块"><a href="#2-1-2加载模块" class="headerlink" title="2.1.2加载模块"></a>2.1.2加载模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-modules-load.service</span><br></pre></td></tr></table></figure>

<h3 id="2-1-3配置Containerd所需的内核"><a href="#2-1-3配置Containerd所需的内核" class="headerlink" title="2.1.3配置Containerd所需的内核"></a>2.1.3配置Containerd所需的内核</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载内核</span></span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<h3 id="2-1-4创建Containerd的配置文件"><a href="#2-1-4创建Containerd的配置文件" class="headerlink" title="2.1.4创建Containerd的配置文件"></a>2.1.4创建Containerd的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/containerd</span><br><span class="line">containerd config default | tee /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改Containerd的配置文件</span><br><span class="line">sed -i &quot;s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g&quot; /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">cat /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">找到containerd.runtimes.runc.options，在其下加入SystemdCgroup = <span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br><span class="line">              SystemdCgroup = true</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将sandbox_image默认地址改为符合版本地址</span></span><br><span class="line"></span><br><span class="line">    sandbox_image = &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-5启动并设置为开机启动"><a href="#2-1-5启动并设置为开机启动" class="headerlink" title="2.1.5启动并设置为开机启动"></a>2.1.5启动并设置为开机启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now containerd</span><br></pre></td></tr></table></figure>

<h3 id="2-1-6配置crictl客户端连接的运行时位置"><a href="#2-1-6配置crictl客户端连接的运行时位置" class="headerlink" title="2.1.6配置crictl客户端连接的运行时位置"></a>2.1.6配置crictl客户端连接的运行时位置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="2-2-k8s与etcd下载及安装（仅在master01操作）"><a href="#2-2-k8s与etcd下载及安装（仅在master01操作）" class="headerlink" title="2.2.k8s与etcd下载及安装（仅在master01操作）"></a>2.2.k8s与etcd下载及安装（仅在master01操作）</h2><h3 id="2-2-1下载k8s安装包（你用哪个下哪个）"><a href="#2-2-1下载k8s安装包（你用哪个下哪个）" class="headerlink" title="2.2.1下载k8s安装包（你用哪个下哪个）"></a>2.2.1下载k8s安装包（你用哪个下哪个）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">1.下载kubernetes1.23.+的二进制包</span><br><span class="line">github二进制包下载地址：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.23.md</span><br><span class="line"></span><br><span class="line">wget https://dl.k8s.io/v1.23.5/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">2.下载etcdctl二进制包</span><br><span class="line">github二进制包下载地址：https://github.com/etcd-io/etcd/releases</span><br><span class="line"></span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.5.2/etcd-v3.5.2-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">3.docker-ce二进制包下载地址</span><br><span class="line">二进制包下载地址：https://download.docker.com/linux/static/stable/x86_64/</span><br><span class="line"></span><br><span class="line">这里需要下载20.10.+版本</span><br><span class="line"></span><br><span class="line">wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.14.tgz</span><br><span class="line"></span><br><span class="line">4.containerd二进制包下载</span><br><span class="line">github下载地址：https://github.com/containerd/containerd/releases</span><br><span class="line"></span><br><span class="line">containerd下载时下载带cni插件的二进制包。</span><br><span class="line"></span><br><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.6.2/cri-containerd-cni-1.6.2-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">5.下载cfssl二进制包</span><br><span class="line">github二进制包下载地址：https://github.com/cloudflare/cfssl/releases</span><br><span class="line"></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64</span><br><span class="line"></span><br><span class="line">6.cni插件下载</span><br><span class="line">github下载地址：https://github.com/containernetworking/plugins/releases</span><br><span class="line"></span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz</span><br><span class="line"></span><br><span class="line">7.crictl客户端二进制下载</span><br><span class="line">github下载：https://github.com/kubernetes-sigs/cri-tools/releases</span><br><span class="line"></span><br><span class="line">wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.23.0/crictl-v1.23.0-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解压k8s安装文件</span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class="line"></span><br><span class="line">解压etcd安装文件</span><br><span class="line">tar -xf etcd-v3.5.2-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.2-linux-amd64/etcd&#123;,ctl&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看/usr/local/bin下内容</span></span><br><span class="line"></span><br><span class="line">ls /usr/local/bin/</span><br><span class="line">etcd  etcdctl  kube-apiserver  kube-controller-manager  kubectl  kubelet  kube-proxy  kube-scheduler</span><br><span class="line"></span><br><span class="line">已经整理好的：</span><br><span class="line">wget https://github.com/cby-chen/Kubernetes/releases/download/v1.23.5/kubernetes-v1.23.5.tar</span><br></pre></td></tr></table></figure>

<h3 id="2-2-2查看版本"><a href="#2-2-2查看版本" class="headerlink" title="2.2.2查看版本"></a>2.2.2查看版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubelet --version</span><br><span class="line">Kubernetes v1.23.5</span><br><span class="line">[root@k8s-master01 ~]# etcdctl version</span><br><span class="line">etcdctl version: 3.5.2</span><br><span class="line">API version: 3.5</span><br><span class="line">[root@k8s-master01 ~]# </span><br></pre></td></tr></table></figure>

<h3 id="2-2-3将组件发送至其他k8s节点"><a href="#2-2-3将组件发送至其他k8s节点" class="headerlink" title="2.2.3将组件发送至其他k8s节点"></a>2.2.3将组件发送至其他k8s节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Master=&#x27;k8s-master02 k8s-master03&#x27;</span><br><span class="line">Work=&#x27;k8s-node01 k8s-node02 k8s-node03 k8s-node04 k8s-node05&#x27;</span><br><span class="line">for NODE in $Master; do echo $NODE; scp /usr/local/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done</span><br><span class="line">for NODE in $Work; do     scp /usr/local/bin/kube&#123;let,-proxy&#125; $NODE:/usr/local/bin/ ; done</span><br></pre></td></tr></table></figure>

<h3 id="2-2-4克隆证书相关文件"><a href="#2-2-4克隆证书相关文件" class="headerlink" title="2.2.4克隆证书相关文件"></a>2.2.4克隆证书相关文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/cby-chen/Kubernetes.git</span><br></pre></td></tr></table></figure>

<h3 id="2-2-5所有k8s节点创建目录"><a href="#2-2-5所有k8s节点创建目录" class="headerlink" title="2.2.5所有k8s节点创建目录"></a>2.2.5所有k8s节点创建目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/cni/bin</span><br></pre></td></tr></table></figure>

<h1 id="3-相关证书生成"><a href="#3-相关证书生成" class="headerlink" title="3.相关证书生成"></a>3.相关证书生成</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">master01节点下载证书生成工具</span><br><span class="line">wget &quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64&quot; -O /usr/local/bin/cfssl</span><br><span class="line">wget &quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64&quot; -O /usr/local/bin/cfssljson</span><br><span class="line">chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure>

<h2 id="3-1-生成etcd证书"><a href="#3-1-生成etcd证书" class="headerlink" title="3.1.生成etcd证书"></a>3.1.生成etcd证书</h2><p>特别说明除外，以下操作在所有master节点操作</p>
<h3 id="3-1-1所有master节点创建证书存放目录"><a href="#3-1-1所有master节点创建证书存放目录" class="headerlink" title="3.1.1所有master节点创建证书存放目录"></a>3.1.1所有master节点创建证书存放目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/etcd/ssl -p</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2master01节点生成etcd证书"><a href="#3-1-2master01节点生成etcd证书" class="headerlink" title="3.1.2master01节点生成etcd证书"></a>3.1.2master01节点生成etcd证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd Kubernetes/pki/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成etcd证书和etcd证书的key（如果你觉得以后可能会扩容，可以在ip那多写几个预留出来）</span></span><br><span class="line"></span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca</span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.61,192.168.1.62,192.168.1.63 \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3将证书复制到其他节点"><a href="#3-1-3将证书复制到其他节点" class="headerlink" title="3.1.3将证书复制到其他节点"></a>3.1.3将证书复制到其他节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Master=&#x27;k8s-master02 k8s-master03&#x27;</span><br><span class="line">for NODE in $Master; do</span><br><span class="line">     ssh $NODE &quot;mkdir -p /etc/etcd/ssl&quot;</span><br><span class="line">     for FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; do</span><br><span class="line">       scp /etc/etcd/ssl/$&#123;FILE&#125; $NODE:/etc/etcd/ssl/$&#123;FILE&#125;</span><br><span class="line">     done</span><br><span class="line"> done</span><br></pre></td></tr></table></figure>

<h2 id="3-2-生成k8s相关证书"><a href="#3-2-生成k8s相关证书" class="headerlink" title="3.2.生成k8s相关证书"></a>3.2.生成k8s相关证书</h2><p>特别说明除外，以下操作在所有master节点操作</p>
<h3 id="3-2-1所有k8s节点创建证书存放目录"><a href="#3-2-1所有k8s节点创建证书存放目录" class="headerlink" title="3.2.1所有k8s节点创建证书存放目录"></a>3.2.1所有k8s节点创建证书存放目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2master01节点生成k8s证书"><a href="#3-2-2master01节点生成k8s证书" class="headerlink" title="3.2.2master01节点生成k8s证书"></a>3.2.2master01节点生成k8s证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成一个根证书</span></span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.96.0.1是service网段的第一个地址，需要计算，192.168.1.59为高可用vip地址</span></span><br><span class="line"></span><br><span class="line">cfssl gencert   \</span><br><span class="line">-ca=/etc/kubernetes/pki/ca.pem   \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/ca-key.pem   \</span><br><span class="line">-config=ca-config.json   \</span><br><span class="line">-hostname=10.96.0.1,192.168.1.59,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,x.oiox.cn,k.oiox.cn,l.oiox.cn,o.oiox.cn,192.168.1.61,192.168.1.62,192.168.1.63,192.168.1.64,192.168.1.65,192.168.1.66,192.168.1.67,192.168.1.68,192.168.1.57,192.168.1.58,192.168.1.40,192.168.1.41   \</span><br><span class="line">-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3生成apiserver聚合证书"><a href="#3-2-3生成apiserver聚合证书" class="headerlink" title="3.2.3生成apiserver聚合证书"></a>3.2.3生成apiserver聚合证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有一个警告，可以忽略</span></span><br><span class="line"></span><br><span class="line">cfssl gencert   -ca=/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   -config=ca-config.json   -profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span><br></pre></td></tr></table></figure>

<h3 id="3-2-4生成controller-manage的证书"><a href="#3-2-4生成controller-manage的证书" class="headerlink" title="3.2.4生成controller-manage的证书"></a>3.2.4生成controller-manage的证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置一个集群项</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://192.168.1.59:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置一个环境项，一个上下文</span></span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-controller-manager \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置一个用户项</span></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">     --client-certificate=/etc/kubernetes/pki/controller-manager.pem \</span><br><span class="line">     --client-key=/etc/kubernetes/pki/controller-manager-key.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认环境</span></span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://192.168.1.59:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">     --client-certificate=/etc/kubernetes/pki/scheduler.pem \</span><br><span class="line">     --client-key=/etc/kubernetes/pki/scheduler-key.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --cluster=kubernetes \</span><br><span class="line">     --user=system:kube-scheduler \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=true     --server=https://192.168.1.59:8443     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubernetes-admin     --client-certificate=/etc/kubernetes/pki/admin.pem     --client-key=/etc/kubernetes/pki/admin-key.pem     --embed-certs=true     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context kubernetes-admin@kubernetes     --cluster=kubernetes     --user=kubernetes-admin     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes-admin@kubernetes     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="3-2-5创建ServiceAccount-Key-——secret"><a href="#3-2-5创建ServiceAccount-Key-——secret" class="headerlink" title="3.2.5创建ServiceAccount Key ——secret"></a>3.2.5创建ServiceAccount Key ——secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="line">openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br></pre></td></tr></table></figure>

<h3 id="3-2-6将证书发送到其他master节点"><a href="#3-2-6将证书发送到其他master节点" class="headerlink" title="3.2.6将证书发送到其他master节点"></a>3.2.6将证书发送到其他master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for NODE in k8s-master02 k8s-master03; do </span><br><span class="line">for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do </span><br><span class="line">scp /etc/kubernetes/pki/$&#123;FILE&#125; $NODE:/etc/kubernetes/pki/$&#123;FILE&#125;;</span><br><span class="line">done; </span><br><span class="line">for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do </span><br><span class="line">scp /etc/kubernetes/$&#123;FILE&#125; $NODE:/etc/kubernetes/$&#123;FILE&#125;;</span><br><span class="line">done;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="3-2-7查看证书"><a href="#3-2-7查看证书" class="headerlink" title="3.2.7查看证书"></a>3.2.7查看证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/kubernetes/pki/</span><br><span class="line">admin.csr      apiserver-key.pem  ca.pem                      front-proxy-ca.csr      front-proxy-client-key.pem  scheduler.csr</span><br><span class="line">admin-key.pem  apiserver.pem      controller-manager.csr      front-proxy-ca-key.pem  front-proxy-client.pem      scheduler-key.pem</span><br><span class="line">admin.pem      ca.csr             controller-manager-key.pem  front-proxy-ca.pem      sa.key                      scheduler.pem</span><br><span class="line">apiserver.csr  ca-key.pem         controller-manager.pem      front-proxy-client.csr  sa.pub</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一共23个就对了</span></span><br><span class="line"></span><br><span class="line">ls /etc/kubernetes/pki/ |wc -l</span><br><span class="line">23</span><br></pre></td></tr></table></figure>

<h1 id="4-k8s系统组件配置"><a href="#4-k8s系统组件配置" class="headerlink" title="4.k8s系统组件配置"></a>4.k8s系统组件配置</h1><h2 id="4-1-etcd配置"><a href="#4-1-etcd配置" class="headerlink" title="4.1.etcd配置"></a>4.1.etcd配置</h2><h3 id="4-1-1master01配置"><a href="#4-1-1master01配置" class="headerlink" title="4.1.1master01配置"></a>4.1.1master01配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master01&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.1.61:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.1.61:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.1.61:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.1.61:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.1.61:2380,k8s-master02=https://192.168.1.62:2380,k8s-master03=https://192.168.1.63:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2master02配置"><a href="#4-1-2master02配置" class="headerlink" title="4.1.2master02配置"></a>4.1.2master02配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master02&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.1.62:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.1.62:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.1.62:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.1.62:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.1.61:2380,k8s-master02=https://192.168.1.62:2380,k8s-master03=https://192.168.1.63:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-1-3master03配置"><a href="#4-1-3master03配置" class="headerlink" title="4.1.3master03配置"></a>4.1.3master03配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master03&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.1.63:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.1.63:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.1.63:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.1.63:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.1.61:2380,k8s-master02=https://192.168.1.62:2380,k8s-master03=https://192.168.1.63:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="4-2-创建service（所有master节点操作）"><a href="#4-2-创建service（所有master节点操作）" class="headerlink" title="4.2.创建service（所有master节点操作）"></a>4.2.创建service（所有master节点操作）</h2><h3 id="4-2-1创建etcd-service并启动"><a href="#4-2-1创建etcd-service并启动" class="headerlink" title="4.2.1创建etcd.service并启动"></a>4.2.1创建etcd.service并启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2创建etcd证书目录"><a href="#4-2-2创建etcd证书目录" class="headerlink" title="4.2.2创建etcd证书目录"></a>4.2.2创建etcd证书目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/kubernetes/pki/etcd</span><br><span class="line">ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now etcd</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3查看etcd状态"><a href="#4-2-3查看etcd状态" class="headerlink" title="4.2.3查看etcd状态"></a>4.2.3查看etcd状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]# export ETCDCTL_API=3</span><br><span class="line">[root@k8s-master01 pki]# etcdctl --endpoints=&quot;192.168.1.63:2379,192.168.1.62:2379,192.168.1.61:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span><br><span class="line">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|     ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| 192.168.1.63:2379 | 7cb7be3df5c81965 |   3.5.2 |   20 kB |     false |      false |         2 |          9 |                  9 |        |</span><br><span class="line">| 192.168.1.62:2379 | c077939949ab3f8b |   3.5.2 |   20 kB |     false |      false |         2 |          9 |                  9 |        |</span><br><span class="line">| 192.168.1.61:2379 | 2ee388f67565dac9 |   3.5.2 |   20 kB |      true |      false |         2 |          9 |                  9 |        |</span><br><span class="line">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">[root@k8s-master01 pki]# </span><br></pre></td></tr></table></figure>

<h1 id="5-高可用配置"><a href="#5-高可用配置" class="headerlink" title="5.高可用配置"></a>5.高可用配置</h1><h2 id="5-1在lb01和lb02两台服务器上操作"><a href="#5-1在lb01和lb02两台服务器上操作" class="headerlink" title="5.1在lb01和lb02两台服务器上操作"></a>5.1在lb01和lb02两台服务器上操作</h2><h3 id="5-1-1安装keepalived和haproxy服务"><a href="#5-1-1安装keepalived和haproxy服务" class="headerlink" title="5.1.1安装keepalived和haproxy服务"></a>5.1.1安装keepalived和haproxy服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum -y install keepalived haproxy</span><br></pre></td></tr></table></figure>

<h3 id="5-1-2修改haproxy配置文件（两台配置文件一样）"><a href="#5-1-2修改haproxy配置文件（两台配置文件一样）" class="headerlink" title="5.1.2修改haproxy配置文件（两台配置文件一样）"></a>5.1.2修改haproxy配置文件（两台配置文件一样）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span></span><br><span class="line"></span><br><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;&quot;EOF&quot;</span><br><span class="line">global</span><br><span class="line"> maxconn 2000</span><br><span class="line"> ulimit-n 16384</span><br><span class="line"> log 127.0.0.1 local0 err</span><br><span class="line"> stats timeout 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line"> log global</span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> timeout connect 5000</span><br><span class="line"> timeout client 50000</span><br><span class="line"> timeout server 50000</span><br><span class="line"> timeout http-request 15s</span><br><span class="line"> timeout http-keep-alive 15s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">frontend monitor-in</span><br><span class="line"> bind *:33305</span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> monitor-uri /monitor</span><br><span class="line"></span><br><span class="line">frontend k8s-master</span><br><span class="line"> bind 0.0.0.0:8443</span><br><span class="line"> bind 127.0.0.1:8443</span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> tcp-request inspect-delay 5s</span><br><span class="line"> default_backend k8s-master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">backend k8s-master</span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> option tcp-check</span><br><span class="line"> balance roundrobin</span><br><span class="line"> default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line"> server  k8s-master01  192.168.1.61:6443 check</span><br><span class="line"> server  k8s-master02  192.168.1.62:6443 check</span><br><span class="line"> server  k8s-master03  192.168.1.63:6443 check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-1-3lb01配置keepalived-master节点"><a href="#5-1-3lb01配置keepalived-master节点" class="headerlink" title="5.1.3lb01配置keepalived master节点"></a>5.1.3lb01配置keepalived master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens18</span><br><span class="line">    mcast_src_ip 192.168.1.57</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.59</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-1-4lb02配置keepalived-backup节点"><a href="#5-1-4lb02配置keepalived-backup节点" class="headerlink" title="5.1.4lb02配置keepalived backup节点"></a>5.1.4lb02配置keepalived backup节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens18</span><br><span class="line">    mcast_src_ip 192.168.1.58</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.59</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-1-5健康检查脚本配置（两台lb主机）"><a href="#5-1-5健康检查脚本配置（两台lb主机）" class="headerlink" title="5.1.5健康检查脚本配置（两台lb主机）"></a>5.1.5健康检查脚本配置（两台lb主机）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /etc/keepalived/check_apiserver.sh &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">err=0</span><br><span class="line">for k in \$(seq 1 3)</span><br><span class="line">do</span><br><span class="line">    check_code=\$(pgrep haproxy)</span><br><span class="line">    if [[ \$check_code == &quot;&quot; ]]; then</span><br><span class="line">        err=\$(expr \$err + 1)</span><br><span class="line">        sleep 1</span><br><span class="line">        continue</span><br><span class="line">    else</span><br><span class="line">        err=0</span><br><span class="line">        break</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [[ \$err != &quot;0&quot; ]]; then</span><br><span class="line">    echo &quot;systemctl stop keepalived&quot;</span><br><span class="line">    /usr/bin/systemctl stop keepalived</span><br><span class="line">    exit 1</span><br><span class="line">else</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给脚本授权</span></span><br><span class="line"></span><br><span class="line">chmod +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure>

<h3 id="5-1-6启动服务"><a href="#5-1-6启动服务" class="headerlink" title="5.1.6启动服务"></a>5.1.6启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now haproxy</span><br><span class="line">systemctl enable --now keepalived</span><br></pre></td></tr></table></figure>

<h3 id="5-1-7测试高可用"><a href="#5-1-7测试高可用" class="headerlink" title="5.1.7测试高可用"></a>5.1.7测试高可用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">能ping同</span></span><br><span class="line"></span><br><span class="line">[root@k8s-node02 ~]# ping 192.168.1.59</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">能telnet访问</span></span><br><span class="line"></span><br><span class="line">[root@k8s-node02 ~]# telnet 192.168.1.59 8443</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭主节点，看vip是否漂移到备节点</span></span><br></pre></td></tr></table></figure>

<h1 id="6-k8s组件配置（区别于第4点）"><a href="#6-k8s组件配置（区别于第4点）" class="headerlink" title="6.k8s组件配置（区别于第4点）"></a>6.k8s组件配置（区别于第4点）</h1><p>所有k8s节点创建以下目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes</span><br></pre></td></tr></table></figure>

<h2 id="6-1-创建apiserver（所有master节点）"><a href="#6-1-创建apiserver（所有master节点）" class="headerlink" title="6.1.创建apiserver（所有master节点）"></a>6.1.创建apiserver（所有master节点）</h2><h3 id="6-1-1master01节点配置"><a href="#6-1-1master01节点配置" class="headerlink" title="6.1.1master01节点配置"></a>6.1.1master01节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=true  \</span><br><span class="line">      --allow-privileged=true  \</span><br><span class="line">      --bind-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=192.168.1.61 \</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://192.168.1.61:2379,https://192.168.1.62:2379,https://192.168.1.63:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --enable-bootstrap-token-auth=true  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line">      # --token-auth-file=/etc/kubernetes/token.csv</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-1-2master02节点配置"><a href="#6-1-2master02节点配置" class="headerlink" title="6.1.2master02节点配置"></a>6.1.2master02节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=true  \</span><br><span class="line">      --allow-privileged=true  \</span><br><span class="line">      --bind-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=192.168.1.62 \</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://192.168.1.61:2379,https://192.168.1.62:2379,https://192.168.1.63:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --enable-bootstrap-token-auth=true  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line">      # --token-auth-file=/etc/kubernetes/token.csv</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-1-3master03节点配置"><a href="#6-1-3master03节点配置" class="headerlink" title="6.1.3master03节点配置"></a>6.1.3master03节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service  &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=true  \</span><br><span class="line">      --allow-privileged=true  \</span><br><span class="line">      --bind-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=192.168.1.63 \</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://192.168.1.61:2379,https://192.168.1.62:2379,https://192.168.1.63:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --enable-bootstrap-token-auth=true  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line">      # --token-auth-file=/etc/kubernetes/token.csv</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-1-4启动apiserver（所有master节点）"><a href="#6-1-4启动apiserver（所有master节点）" class="headerlink" title="6.1.4启动apiserver（所有master节点）"></a>6.1.4启动apiserver（所有master节点）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable --now kube-apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意查看状态是否启动正常</span></span><br><span class="line"></span><br><span class="line">systemctl status kube-apiserver</span><br></pre></td></tr></table></figure>

<h2 id="6-2-配置kube-controller-manager-service"><a href="#6-2-配置kube-controller-manager-service" class="headerlink" title="6.2.配置kube-controller-manager service"></a>6.2.配置kube-controller-manager service</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">所有master节点配置，且配置相同</span><br><span class="line">172.16.0.0/12为pod网段，按需求设置你自己的网段</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=true \</span><br><span class="line">      --address=127.0.0.1 \</span><br><span class="line">      --root-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \</span><br><span class="line">      --leader-elect=true \</span><br><span class="line">      --use-service-account-credentials=true \</span><br><span class="line">      --node-monitor-grace-period=40s \</span><br><span class="line">      --node-monitor-period=5s \</span><br><span class="line">      --pod-eviction-timeout=2m0s \</span><br><span class="line">      --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">      --allocate-node-cidrs=true \</span><br><span class="line">      --cluster-cidr=172.16.0.0/12 \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">      --node-cidr-mask-size=24</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-2-1启动kube-controller-manager，并查看状态"><a href="#6-2-1启动kube-controller-manager，并查看状态" class="headerlink" title="6.2.1启动kube-controller-manager，并查看状态"></a>6.2.1启动kube-controller-manager，并查看状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kube-controller-manager</span><br><span class="line">systemctl  status kube-controller-manager</span><br></pre></td></tr></table></figure>

<h2 id="6-3-配置kube-scheduler-service"><a href="#6-3-配置kube-scheduler-service" class="headerlink" title="6.3.配置kube-scheduler service"></a>6.3.配置kube-scheduler service</h2><h3 id="6-3-1所有master节点配置，且配置相同"><a href="#6-3-1所有master节点配置，且配置相同" class="headerlink" title="6.3.1所有master节点配置，且配置相同"></a>6.3.1所有master节点配置，且配置相同</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=true \</span><br><span class="line">      --address=127.0.0.1 \</span><br><span class="line">      --leader-elect=true \</span><br><span class="line">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-3-2启动并查看服务状态"><a href="#6-3-2启动并查看服务状态" class="headerlink" title="6.3.2启动并查看服务状态"></a>6.3.2启动并查看服务状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br></pre></td></tr></table></figure>

<h1 id="7-TLS-Bootstrapping配置"><a href="#7-TLS-Bootstrapping配置" class="headerlink" title="7.TLS Bootstrapping配置"></a>7.TLS Bootstrapping配置</h1><h2 id="7-1在master01上配置"><a href="#7-1在master01上配置" class="headerlink" title="7.1在master01上配置"></a>7.1在master01上配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd /root/Kubernetes/bootstrap</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=true     --server=https://192.168.1.59:8443     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials tls-bootstrap-token-user     --token=c8ad9c.2e4d610cf3e7426e --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context tls-bootstrap-token-user@kubernetes     --cluster=kubernetes     --user=tls-bootstrap-token-user     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context tls-bootstrap-token-user@kubernetes     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span></span><br><span class="line"></span><br><span class="line">mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span><br></pre></td></tr></table></figure>

<h2 id="7-2查看集群状态，没问题的话继续后续操作"><a href="#7-2查看集群状态，没问题的话继续后续操作" class="headerlink" title="7.2查看集群状态，没问题的话继续后续操作"></a>7.2查看集群状态，没问题的话继续后续操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">controller-manager   Healthy   ok                              </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;   </span><br><span class="line">scheduler            Healthy   ok                              </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;  </span><br><span class="line"></span><br><span class="line">kubectl create -f bootstrap.secret.yaml</span><br></pre></td></tr></table></figure>

<h1 id="8-node节点配置"><a href="#8-node节点配置" class="headerlink" title="8.node节点配置"></a>8.node节点配置</h1><h2 id="8-1-在master01上将证书复制到node节点"><a href="#8-1-在master01上将证书复制到node节点" class="headerlink" title="8.1.在master01上将证书复制到node节点"></a>8.1.在master01上将证书复制到node节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/</span><br><span class="line"></span><br><span class="line">for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02 k8s-node03 k8s-node04 k8s-node05; do</span><br><span class="line">     ssh $NODE mkdir -p /etc/kubernetes/pki</span><br><span class="line">     for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; do</span><br><span class="line">       scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/$&#123;FILE&#125;</span><br><span class="line"> done</span><br><span class="line"> done</span><br></pre></td></tr></table></figure>

<h2 id="8-2-kubelet配置"><a href="#8-2-kubelet配置" class="headerlink" title="8.2.kubelet配置"></a>8.2.kubelet配置</h2><h3 id="8-2-1所有k8s节点创建相关目录"><a href="#8-2-1所有k8s节点创建相关目录" class="headerlink" title="8.2.1所有k8s节点创建相关目录"></a>8.2.1所有k8s节点创建相关目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">所有k8s节点配置kubelet service</span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \</span><br><span class="line">    --network-plugin=cni  \</span><br><span class="line">    --cni-conf-dir=/etc/cni/net.d  \</span><br><span class="line">    --cni-bin-dir=/opt/cni/bin  \</span><br><span class="line">    --container-runtime=remote  \</span><br><span class="line">    --runtime-request-timeout=15m  \</span><br><span class="line">    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \</span><br><span class="line">    --cgroup-driver=systemd \</span><br><span class="line">    --node-labels=node.kubernetes.io/node=&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-2-2所有k8s节点创建kubelet的配置文件"><a href="#8-2-2所有k8s节点创建kubelet的配置文件" class="headerlink" title="8.2.2所有k8s节点创建kubelet的配置文件"></a>8.2.2所有k8s节点创建kubelet的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: true</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: true</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-2-3启动kubelet"><a href="#8-2-3启动kubelet" class="headerlink" title="8.2.3启动kubelet"></a>8.2.3启动kubelet</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>

<h3 id="8-2-4查看集群"><a href="#8-2-4查看集群" class="headerlink" title="8.2.4查看集群"></a>8.2.4查看集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl  get node</span><br><span class="line">NAME           STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master01   NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-master02   NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-master03   NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node01     NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node02     NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node03     NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node04     NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node05     NotReady   &lt;none&gt;   14h   v1.23.5</span><br><span class="line">[root@k8s-master01 ~]#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="8-3-kube-proxy配置"><a href="#8-3-kube-proxy配置" class="headerlink" title="8.3.kube-proxy配置"></a>8.3.kube-proxy配置</h2><h3 id="8-3-1此配置只在master01操作"><a href="#8-3-1此配置只在master01操作" class="headerlink" title="8.3.1此配置只在master01操作"></a>8.3.1此配置只在master01操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd /root/Kubernetes/</span><br><span class="line">kubectl -n kube-system create serviceaccount kube-proxy</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding system:kube-proxy         --clusterrole system:node-proxier         --serviceaccount kube-system:kube-proxy</span><br><span class="line"></span><br><span class="line">SECRET=$(kubectl -n kube-system get sa/kube-proxy \</span><br><span class="line">    --output=jsonpath=&#x27;&#123;.secrets[0].name&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">JWT_TOKEN=$(kubectl -n kube-system get secret/$SECRET \</span><br><span class="line">--output=jsonpath=&#x27;&#123;.data.token&#125;&#x27; | base64 -d)</span><br><span class="line"></span><br><span class="line">PKI_DIR=/etc/kubernetes/pki</span><br><span class="line">K8S_DIR=/etc/kubernetes</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=true     --server=https://192.168.1.59:8443     --kubeconfig=$&#123;K8S_DIR&#125;/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubernetes     --token=$&#123;JWT_TOKEN&#125;     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context kubernetes     --cluster=kubernetes     --user=kubernetes     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="8-3-2将kubeconfig发送至其他节点"><a href="#8-3-2将kubeconfig发送至其他节点" class="headerlink" title="8.3.2将kubeconfig发送至其他节点"></a>8.3.2将kubeconfig发送至其他节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for NODE in k8s-master02 k8s-master03; do</span><br><span class="line">     scp /etc/kubernetes/kube-proxy.kubeconfig  $NODE:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"> done</span><br><span class="line"></span><br><span class="line">for NODE in k8s-node01 k8s-node02 k8s-node03 k8s-node04 k8s-node05; do</span><br><span class="line">     scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"> done</span><br></pre></td></tr></table></figure>

<h3 id="8-3-3所有k8s节点添加kube-proxy的配置和service文件"><a href="#8-3-3所有k8s节点添加kube-proxy的配置和service文件" class="headerlink" title="8.3.3所有k8s节点添加kube-proxy的配置和service文件"></a>8.3.3所有k8s节点添加kube-proxy的配置和service文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.yaml \</span><br><span class="line">  --v=2</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: 172.16.0.0/12 </span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  masqueradeAll: true</span><br><span class="line">  minSyncPeriod: 5s</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: &quot;ipvs&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 250ms</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-3-4启动kube-proxy"><a href="#8-3-4启动kube-proxy" class="headerlink" title="8.3.4启动kube-proxy"></a>8.3.4启动kube-proxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kube-proxy</span><br></pre></td></tr></table></figure>

<h1 id="9-安装Calico"><a href="#9-安装Calico" class="headerlink" title="9.安装Calico"></a>9.安装Calico</h1><h2 id="9-1以下步骤只在master01操作"><a href="#9-1以下步骤只在master01操作" class="headerlink" title="9.1以下步骤只在master01操作"></a>9.1以下步骤只在master01操作</h2><h3 id="9-1-1更改calico网段"><a href="#9-1-1更改calico网段" class="headerlink" title="9.1.1更改calico网段"></a>9.1.1更改calico网段</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /root/Kubernetes/calico/</span><br><span class="line">sed -i &quot;s#POD_CIDR#172.16.0.0/12#g&quot; calico.yaml</span><br><span class="line">grep &quot;IPV4POOL_CIDR&quot; calico.yaml  -A 1</span><br><span class="line">            - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">              value: &quot;172.16.0.0/12&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>

<h3 id="9-1-2查看容器状态"><a href="#9-1-2查看容器状态" class="headerlink" title="9.1.2查看容器状态"></a>9.1.2查看容器状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl  get pod -A</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6f6595874c-nb95g   1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-node-67dn4                          1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-node-79zxj                          1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-node-85bsf                          1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-node-8trsm                          1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-node-dvz72                          1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-node-qqzwx                          1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-node-rngzq                          1/1     Running   0          2m55s</span><br><span class="line">kube-system   calico-node-w8gqp                          1/1     Running   0          2m54s</span><br><span class="line">kube-system   calico-typha-6b6cf8cbdf-2b454              1/1     Running   0          2m55s</span><br><span class="line">[root@k8s-master01 ~]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]# kubectl  get node</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master01   Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node03     Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node04     Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">k8s-node05     Ready    &lt;none&gt;   14h   v1.23.5</span><br><span class="line">[root@k8s-master01 ~]# </span><br></pre></td></tr></table></figure>

<h1 id="10-安装CoreDNS"><a href="#10-安装CoreDNS" class="headerlink" title="10.安装CoreDNS"></a>10.安装CoreDNS</h1><h2 id="10-1以下步骤只在master01操作"><a href="#10-1以下步骤只在master01操作" class="headerlink" title="10.1以下步骤只在master01操作"></a>10.1以下步骤只在master01操作</h2><h3 id="10-1-1修改文件"><a href="#10-1-1修改文件" class="headerlink" title="10.1.1修改文件"></a>10.1.1修改文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /root/Kubernetes/CoreDNS/</span><br><span class="line">sed -i &quot;s#KUBEDNS_SERVICE_IP#10.96.0.10#g&quot; coredns.yaml</span><br><span class="line"></span><br><span class="line">cat coredns.yaml | grep clusterIP:</span><br><span class="line">  clusterIP: 10.96.0.10 </span><br></pre></td></tr></table></figure>

<h3 id="10-1-2安装"><a href="#10-1-2安装" class="headerlink" title="10.1.2安装"></a>10.1.2安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl  create -f coredns.yaml </span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure>

<h1 id="11-安装Metrics-Server"><a href="#11-安装Metrics-Server" class="headerlink" title="11.安装Metrics Server"></a>11.安装Metrics Server</h1><h2 id="11-1以下步骤只在master01操作"><a href="#11-1以下步骤只在master01操作" class="headerlink" title="11.1以下步骤只在master01操作"></a>11.1以下步骤只在master01操作</h2><h3 id="11-1-1安装Metrics-server"><a href="#11-1-1安装Metrics-server" class="headerlink" title="11.1.1安装Metrics-server"></a>11.1.1安装Metrics-server</h3><p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">安装metrics server</span><br><span class="line">cd /root/Kubernetes/metrics-server/</span><br><span class="line"></span><br><span class="line">kubectl  create -f . </span><br><span class="line"></span><br><span class="line">serviceaccount/metrics-server created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">service/metrics-server created</span><br><span class="line">deployment.apps/metrics-server created</span><br><span class="line">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span><br></pre></td></tr></table></figure>

<h3 id="11-1-2稍等片刻查看状态"><a href="#11-1-2稍等片刻查看状态" class="headerlink" title="11.1.2稍等片刻查看状态"></a>11.1.2稍等片刻查看状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl  top node</span><br><span class="line">NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master01   154m         1%     1715Mi          21%       </span><br><span class="line">k8s-master02   151m         1%     1274Mi          16%       </span><br><span class="line">k8s-master03   523m         6%     1345Mi          17%       </span><br><span class="line">k8s-node01     84m          1%     671Mi           8%        </span><br><span class="line">k8s-node02     73m          0%     727Mi           9%        </span><br><span class="line">k8s-node03     96m          1%     769Mi           9%        </span><br><span class="line">k8s-node04     68m          0%     673Mi           8%        </span><br><span class="line">k8s-node05     82m          1%     679Mi           8% </span><br></pre></td></tr></table></figure>

<h1 id="12-集群验证"><a href="#12-集群验证" class="headerlink" title="12.集群验证"></a>12.集群验证</h1><h2 id="12-1部署pod资源"><a href="#12-1部署pod资源" class="headerlink" title="12.1部署pod资源"></a>12.1部署pod资源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line"></span><br><span class="line">kubectl  get pod</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox   1/1     Running   0          17s</span><br></pre></td></tr></table></figure>

<h2 id="12-2用pod解析默认命名空间中的kubernetes"><a href="#12-2用pod解析默认命名空间中的kubernetes" class="headerlink" title="12.2用pod解析默认命名空间中的kubernetes"></a>12.2用pod解析默认命名空间中的kubernetes</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   17h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl exec  busybox -n default -- nslookup kubernetes</span><br><span class="line">3Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="12-3测试跨命名空间是否可以解析"><a href="#12-3测试跨命名空间是否可以解析" class="headerlink" title="12.3测试跨命名空间是否可以解析"></a>12.3测试跨命名空间是否可以解析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec  busybox -n default -- nslookup kube-dns.kube-system</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kube-dns.kube-system</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="12-4每个节点都必须要能访问Kubernetes的kubernetes-svc-443和kube-dns的service-53"><a href="#12-4每个节点都必须要能访问Kubernetes的kubernetes-svc-443和kube-dns的service-53" class="headerlink" title="12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53"></a>12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">telnet 10.96.0.1 443</span><br><span class="line">Trying 10.96.0.1...</span><br><span class="line">Connected to 10.96.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line"> telnet 10.96.0.10 53</span><br><span class="line">Trying 10.96.0.10...</span><br><span class="line">Connected to 10.96.0.10.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line">curl 10.96.0.10:53</span><br><span class="line">curl: (52) Empty reply from server</span><br></pre></td></tr></table></figure>

<h2 id="12-5Pod和Pod之前要能通"><a href="#12-5Pod和Pod之前要能通" class="headerlink" title="12.5Pod和Pod之前要能通"></a>12.5Pod和Pod之前要能通</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -owide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">busybox   1/1     Running   0          17m   172.27.14.193   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"> kubectl get po -n kube-system -owide</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS      AGE   IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-kube-controllers-5dffd5886b-4blh6   1/1     Running   0             77m   172.25.244.193   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-fvbdq                          1/1     Running   1 (75m ago)   77m   192.168.1.61     k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-g8nqd                          1/1     Running   0             77m   192.168.1.64     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-mdps8                          1/1     Running   0             77m   192.168.1.65     k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-nf4nt                          1/1     Running   0             77m   192.168.1.63     k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-sq2ml                          1/1     Running   0             77m   192.168.1.62     k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-typha-8445487f56-mg6p8              1/1     Running   0             77m   192.168.1.65     k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-typha-8445487f56-pxbpj              1/1     Running   0             77m   192.168.1.61     k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-typha-8445487f56-tnssl              1/1     Running   0             77m   192.168.1.64     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-5db5696c7-67h79                    1/1     Running   0             63m   172.25.92.65     k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">metrics-server-6bf7dcd649-5fhrw            1/1     Running   0             61m   172.18.195.1     k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入busybox ping其他节点上的pod</span></span><br><span class="line"></span><br><span class="line">kubectl exec -ti busybox -- sh</span><br><span class="line">/ # ping 192.168.1.64</span><br><span class="line">PING 192.168.1.64 (192.168.1.64): 56 data bytes</span><br><span class="line">64 bytes from 192.168.1.64: seq=0 ttl=63 time=0.358 ms</span><br><span class="line">64 bytes from 192.168.1.64: seq=1 ttl=63 time=0.668 ms</span><br><span class="line">64 bytes from 192.168.1.64: seq=2 ttl=63 time=0.637 ms</span><br><span class="line">64 bytes from 192.168.1.64: seq=3 ttl=63 time=0.624 ms</span><br><span class="line">64 bytes from 192.168.1.64: seq=4 ttl=63 time=0.907 ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以连通证明这个pod是可以跨命名空间和跨主机通信的</span></span><br></pre></td></tr></table></figure>

<h2 id="12-6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）"><a href="#12-6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）" class="headerlink" title="12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）"></a>12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; deployments.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.14.2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl  apply -f deployments.yaml </span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line"></span><br><span class="line">kubectl  get pod </span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox                            1/1     Running   0          6m25s</span><br><span class="line">nginx-deployment-9456bbbf9-4bmvk   1/1     Running   0          8s</span><br><span class="line">nginx-deployment-9456bbbf9-9rcdk   1/1     Running   0          8s</span><br><span class="line">nginx-deployment-9456bbbf9-dqv8s   1/1     Running   0          8s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除nginx</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]# kubectl delete -f deployments.yaml </span><br></pre></td></tr></table></figure>

<h1 id="13-安装dashboard"><a href="#13-安装dashboard" class="headerlink" title="13.安装dashboard"></a>13.安装dashboard</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd /root/Kubernetes/dashboard/</span><br><span class="line"></span><br><span class="line">kubectl  create -f .</span><br><span class="line">serviceaccount/admin-user created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br><span class="line">namespace/kubernetes-dashboard created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-csrf created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/dashboard-metrics-scraper created</span><br><span class="line">deployment.apps/dashboard-metrics-scraper created</span><br></pre></td></tr></table></figure>

<h2 id="13-1创建管理员用户"><a href="#13-1创建管理员用户" class="headerlink" title="13.1创建管理员用户"></a>13.1创建管理员用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; admin.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line"></span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding </span><br><span class="line">metadata: </span><br><span class="line">  name: admin-user</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line"></span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="13-2执行yaml文件"><a href="#13-2执行yaml文件" class="headerlink" title="13.2执行yaml文件"></a>13.2执行yaml文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f admin.yaml -n kube-system</span><br><span class="line"></span><br><span class="line">serviceaccount/admin-user created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br></pre></td></tr></table></figure>

<h2 id="13-3更改dashboard的svc为NodePort，如果已是请忽略"><a href="#13-3更改dashboard的svc为NodePort，如果已是请忽略" class="headerlink" title="13.3更改dashboard的svc为NodePort，如果已是请忽略"></a>13.3更改dashboard的svc为NodePort，如果已是请忽略</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>

<h2 id="13-4查看端口号"><a href="#13-4查看端口号" class="headerlink" title="13.4查看端口号"></a>13.4查看端口号</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.98.201.22   &lt;none&gt;        443:31245/TCP   10m</span><br></pre></td></tr></table></figure>

<h2 id="13-5查看token"><a href="#13-5查看token" class="headerlink" title="13.5查看token"></a>13.5查看token</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">Name:         admin-user-token-5vfk4</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: fc2535ae-8760-4037-9026-966f03ab9bf9</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1363 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6InVOMnhMdHFTRWxweUlfUm93VmhMZTVXZW1FXzFrT01nQ0dTcE5uYjJlNWMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTV2Zms0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJmYzI1MzVhZS04NzYwLTQwMzctOTAyNi05NjZmMDNhYjliZjkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.HSU1FeqY6pDVoXVIv4Lu27TDhCYHM-FzGsGybYL5QPJ5-P0b3tQqUH9i3AQlisiGPB--jCFT5CUeOeXneOyfV7XkC7frbn6VaQoh51n6ztkIvjUm8Q4xj_LQ2OSFfWlFUnaZsaYTdD-RCldwh63pX362T_FjgDknO4q1wtKZH5qR0mpL1dOjas50gnOSyBY0j-nSPrifhnNq3_GcDLE4LxjuzO1DfGNTEHZ6TojPJ_5ZElMolaYJsVejn2slfeUQEWdiD5AHFZlRd4exODCHyvUhRpzb9jO2rovN2LMqdE_vxBtNgXp19evQB9AgZyMMSmu1Ch2C2UAi4NxjKw8HNA</span><br></pre></td></tr></table></figure>

<h2 id="13-6登录dashboard"><a href="#13-6登录dashboard" class="headerlink" title="13.6登录dashboard"></a>13.6登录dashboard</h2><p><a target="_blank" rel="noopener" href="https://192.168.1.61:31245/">https://192.168.1.61:31245/</a></p>
<p>eyJhbGciOiJSUzI1NiIsImtpZCI6InYzV2dzNnQzV3hHb2FQWnYzdnlOSmpudmtpVmNjQW5VM3daRi12SFM4dEEifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWs1NDVrIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJjMzA4MDcxYy00Y2Y1LTQ1ODMtODNhMi1lYWY3ODEyNTEyYjQiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.pshvZPi9ZJkXUWuWilcYs1wawTpzV-nMKesgF3d_l7qyTPaK2N5ofzIThd0SjzU7BFNb4_rOm1dw1Be5kLeHjY_YW5lDnM5TAxVPXmZQ0HJ2pAQ0pjQqCHFnPD0bZFIYkeyz8pZx0Hmwcd3ZdC1yztr0ADpTAmMgI9NC2ZFIeoFFo4Ue9ZM_ulhqJQjmgoAlI_qbyjuKCNsWeEQBwM6HHHAsH1gOQIdVxqQ83OQZUuynDQRpqlHHFIndbK2zVRYFA3GgUnTu2-VRQ-DXBFRjvZR5qArnC1f383jmIjGT6VO7l04QJteG_LFetRbXa-T4mcnbsd8XutSgO0INqwKpjw</p>
<h1 id="14-安装命令行自动补全功能"><a href="#14-安装命令行自动补全功能" class="headerlink" title="14.安装命令行自动补全功能"></a>14.安装命令行自动补全功能</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<h1 id="附录："><a href="#附录：" class="headerlink" title="附录："></a>附录：</h1><p>配置kube-controller-manager有效期100年（能不能生效的先配上再说）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Service]下找个地方加上</span></span><br><span class="line"></span><br><span class="line">--cluster-signing-duration=876000h0m0s \</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart kube-controller-manager</span><br></pre></td></tr></table></figure>

<p>防止漏洞扫描</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span><br><span class="line"></span><br><span class="line">[Service] </span><br><span class="line">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--kubeconfig=/etc/kubernetes/kubelet.kubeconfig --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig&quot; </span><br><span class="line">Environment=&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot; </span><br><span class="line">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot; </span><br><span class="line">Environment=&quot;KUBELET_EXTRA_ARGS=--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384    --image-pull-progress-deadline=30m&quot; </span><br><span class="line">ExecStart= </span><br><span class="line">ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS </span><br></pre></td></tr></table></figure>

<p>预留空间，按需分配</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/kubelet-conf.yml</span><br><span class="line"></span><br><span class="line">rotateServerCertificates: true</span><br><span class="line">allowedUnsafeSysctls:</span><br><span class="line"></span><br><span class="line"> - &quot;net.core*&quot;</span><br><span class="line"> - &quot;net.ipv4.*&quot;</span><br><span class="line">   kubeReserved:</span><br><span class="line">     cpu: &quot;1&quot;</span><br><span class="line">     memory: 1Gi</span><br><span class="line">     ephemeral-storage: 10Gi</span><br><span class="line">   systemReserved:</span><br><span class="line">     cpu: &quot;1&quot;</span><br><span class="line">     memory: 1Gi</span><br><span class="line">     ephemeral-storage: 10Gi</span><br></pre></td></tr></table></figure>

<p>数据盘要与系统盘分开；etcd使用ssd磁盘</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title="0" data-url="https://www.oiox.cn/1.mp3"></li>
                        
                    
                        
                            <li title="1" data-url="https://www.oiox.cn/2.mp3"></li>
                        
                    
                </ul>
            
        </div>
        
    <div id="gitalk-container" class="comment link"
		data-enable="false"
        data-ae="false"
        data-ci=""
        data-cs=""
        data-r=""
        data-o=""
        data-a=""
        data-d="false"
    >查看评论</div>


    </div>
    
        <div class="side">
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">1.环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-k8s%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">1.1.k8s基础系统环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E9%85%8D%E7%BD%AEIP"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.2.配置IP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E8%AE%BE%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.3.设置主机名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E9%85%8D%E7%BD%AEyum%E6%BA%90"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.4.配置yum源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E5%AE%89%E8%A3%85%E4%B8%80%E4%BA%9B%E5%BF%85%E5%A4%87%E5%B7%A5%E5%85%B7"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.5.安装一些必备工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-%E5%AE%89%E8%A3%85docker%E5%B7%A5%E5%85%B7-lb%E9%99%A4%E5%A4%96"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.6.安装docker工具 (lb除外)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.7.关闭防火墙</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-%E5%85%B3%E9%97%ADSELinux"><span class="toc-number">1.1.7.</span> <span class="toc-text">1.8.关闭SELinux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-%E5%85%B3%E9%97%AD%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA"><span class="toc-number">1.1.8.</span> <span class="toc-text">1.9.关闭交换分区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-10-%E5%85%B3%E9%97%ADNetworkManager-%E5%B9%B6%E5%90%AF%E7%94%A8-network-lb%E9%99%A4%E5%A4%96"><span class="toc-number">1.1.9.</span> <span class="toc-text">1.10.关闭NetworkManager 并启用 network (lb除外)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-11-%E8%BF%9B%E8%A1%8C%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5-lb%E9%99%A4%E5%A4%96"><span class="toc-number">1.1.10.</span> <span class="toc-text">1.11.进行时间同步 (lb除外)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-12-%E9%85%8D%E7%BD%AEulimit"><span class="toc-number">1.1.11.</span> <span class="toc-text">1.12.配置ulimit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-13-%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="toc-number">1.1.12.</span> <span class="toc-text">1.13.配置免密登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-14-%E6%B7%BB%E5%8A%A0%E5%90%AF%E7%94%A8%E6%BA%90-lb%E9%99%A4%E5%A4%96"><span class="toc-number">1.1.13.</span> <span class="toc-text">1.14.添加启用源 (lb除外)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-15-%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8%E8%87%B34-18%E7%89%88%E6%9C%AC%E4%BB%A5%E4%B8%8A-lb%E9%99%A4%E5%A4%96"><span class="toc-number">1.1.14.</span> <span class="toc-text">1.15.升级内核至4.18版本以上 (lb除外)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-16-%E5%AE%89%E8%A3%85ipvsadm-lb%E9%99%A4%E5%A4%96"><span class="toc-number">1.1.15.</span> <span class="toc-text">1.16.安装ipvsadm (lb除外)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-17-%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0-lb%E9%99%A4%E5%A4%96"><span class="toc-number">1.1.16.</span> <span class="toc-text">1.17.修改内核参数 (lb除外)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-18-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AEhosts%E6%9C%AC%E5%9C%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">1.1.17.</span> <span class="toc-text">1.18.所有节点配置hosts本地解析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-k8s%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">2.k8s基本组件安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%89%80%E6%9C%89k8s%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85Containerd%E4%BD%9C%E4%B8%BARuntime"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.所有k8s节点安装Containerd作为Runtime</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1%E9%85%8D%E7%BD%AEContainerd%E6%89%80%E9%9C%80%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1配置Containerd所需的模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2加载模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3%E9%85%8D%E7%BD%AEContainerd%E6%89%80%E9%9C%80%E7%9A%84%E5%86%85%E6%A0%B8"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3配置Containerd所需的内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4%E5%88%9B%E5%BB%BAContainerd%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4创建Containerd的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-5%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">2.1.5.</span> <span class="toc-text">2.1.5启动并设置为开机启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-6%E9%85%8D%E7%BD%AEcrictl%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.1.6.</span> <span class="toc-text">2.1.6配置crictl客户端连接的运行时位置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-k8s%E4%B8%8Eetcd%E4%B8%8B%E8%BD%BD%E5%8F%8A%E5%AE%89%E8%A3%85%EF%BC%88%E4%BB%85%E5%9C%A8master01%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.k8s与etcd下载及安装（仅在master01操作）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1%E4%B8%8B%E8%BD%BDk8s%E5%AE%89%E8%A3%85%E5%8C%85%EF%BC%88%E4%BD%A0%E7%94%A8%E5%93%AA%E4%B8%AA%E4%B8%8B%E5%93%AA%E4%B8%AA%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1下载k8s安装包（你用哪个下哪个）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2查看版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3%E5%B0%86%E7%BB%84%E4%BB%B6%E5%8F%91%E9%80%81%E8%87%B3%E5%85%B6%E4%BB%96k8s%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3将组件发送至其他k8s节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4%E5%85%8B%E9%9A%86%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4克隆证书相关文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5%E6%89%80%E6%9C%89k8s%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.2.5所有k8s节点创建目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%9B%B8%E5%85%B3%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90"><span class="toc-number">3.</span> <span class="toc-text">3.相关证书生成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E7%94%9F%E6%88%90etcd%E8%AF%81%E4%B9%A6"><span class="toc-number">3.1.</span> <span class="toc-text">3.1.生成etcd证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1%E6%89%80%E6%9C%89master%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">3.1.1所有master节点创建证书存放目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2master01%E8%8A%82%E7%82%B9%E7%94%9F%E6%88%90etcd%E8%AF%81%E4%B9%A6"><span class="toc-number">3.1.2.</span> <span class="toc-text">3.1.2master01节点生成etcd证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3%E5%B0%86%E8%AF%81%E4%B9%A6%E5%A4%8D%E5%88%B6%E5%88%B0%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.1.3将证书复制到其他节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%94%9F%E6%88%90k8s%E7%9B%B8%E5%85%B3%E8%AF%81%E4%B9%A6"><span class="toc-number">3.2.</span> <span class="toc-text">3.2.生成k8s相关证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1%E6%89%80%E6%9C%89k8s%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1所有k8s节点创建证书存放目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2master01%E8%8A%82%E7%82%B9%E7%94%9F%E6%88%90k8s%E8%AF%81%E4%B9%A6"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2master01节点生成k8s证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3%E7%94%9F%E6%88%90apiserver%E8%81%9A%E5%90%88%E8%AF%81%E4%B9%A6"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3生成apiserver聚合证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4%E7%94%9F%E6%88%90controller-manage%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.2.4生成controller-manage的证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5%E5%88%9B%E5%BB%BAServiceAccount-Key-%E2%80%94%E2%80%94secret"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.2.5创建ServiceAccount Key ——secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-6%E5%B0%86%E8%AF%81%E4%B9%A6%E5%8F%91%E9%80%81%E5%88%B0%E5%85%B6%E4%BB%96master%E8%8A%82%E7%82%B9"><span class="toc-number">3.2.6.</span> <span class="toc-text">3.2.6将证书发送到其他master节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-7%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6"><span class="toc-number">3.2.7.</span> <span class="toc-text">3.2.7查看证书</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-k8s%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">4.k8s系统组件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-etcd%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">4.1.etcd配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1master01%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1master01配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2master02%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2master02配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3master03%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.3.</span> <span class="toc-text">4.1.3master03配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%88%9B%E5%BB%BAservice%EF%BC%88%E6%89%80%E6%9C%89master%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">4.2.创建service（所有master节点操作）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1%E5%88%9B%E5%BB%BAetcd-service%E5%B9%B6%E5%90%AF%E5%8A%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1创建etcd.service并启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2%E5%88%9B%E5%BB%BAetcd%E8%AF%81%E4%B9%A6%E7%9B%AE%E5%BD%95"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2创建etcd证书目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3%E6%9F%A5%E7%9C%8Betcd%E7%8A%B6%E6%80%81"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3查看etcd状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">5.高可用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E5%9C%A8lb01%E5%92%8Clb02%E4%B8%A4%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%93%8D%E4%BD%9C"><span class="toc-number">5.1.</span> <span class="toc-text">5.1在lb01和lb02两台服务器上操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1%E5%AE%89%E8%A3%85keepalived%E5%92%8Chaproxy%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.1.</span> <span class="toc-text">5.1.1安装keepalived和haproxy服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2%E4%BF%AE%E6%94%B9haproxy%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%88%E4%B8%A4%E5%8F%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%80%E6%A0%B7%EF%BC%89"><span class="toc-number">5.1.2.</span> <span class="toc-text">5.1.2修改haproxy配置文件（两台配置文件一样）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3lb01%E9%85%8D%E7%BD%AEkeepalived-master%E8%8A%82%E7%82%B9"><span class="toc-number">5.1.3.</span> <span class="toc-text">5.1.3lb01配置keepalived master节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-4lb02%E9%85%8D%E7%BD%AEkeepalived-backup%E8%8A%82%E7%82%B9"><span class="toc-number">5.1.4.</span> <span class="toc-text">5.1.4lb02配置keepalived backup节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-5%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%AC%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%A4%E5%8F%B0lb%E4%B8%BB%E6%9C%BA%EF%BC%89"><span class="toc-number">5.1.5.</span> <span class="toc-text">5.1.5健康检查脚本配置（两台lb主机）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-6%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.6.</span> <span class="toc-text">5.1.6启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-7%E6%B5%8B%E8%AF%95%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">5.1.7.</span> <span class="toc-text">5.1.7测试高可用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-k8s%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE%EF%BC%88%E5%8C%BA%E5%88%AB%E4%BA%8E%E7%AC%AC4%E7%82%B9%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">6.k8s组件配置（区别于第4点）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%88%9B%E5%BB%BAapiserver%EF%BC%88%E6%89%80%E6%9C%89master%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.1.</span> <span class="toc-text">6.1.创建apiserver（所有master节点）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1master01%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.1.</span> <span class="toc-text">6.1.1master01节点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2master02%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.2.</span> <span class="toc-text">6.1.2master02节点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3master03%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.3.</span> <span class="toc-text">6.1.3master03节点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-4%E5%90%AF%E5%8A%A8apiserver%EF%BC%88%E6%89%80%E6%9C%89master%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.1.4.</span> <span class="toc-text">6.1.4启动apiserver（所有master节点）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E9%85%8D%E7%BD%AEkube-controller-manager-service"><span class="toc-number">6.2.</span> <span class="toc-text">6.2.配置kube-controller-manager service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1%E5%90%AF%E5%8A%A8kube-controller-manager%EF%BC%8C%E5%B9%B6%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81"><span class="toc-number">6.2.1.</span> <span class="toc-text">6.2.1启动kube-controller-manager，并查看状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E9%85%8D%E7%BD%AEkube-scheduler-service"><span class="toc-number">6.3.</span> <span class="toc-text">6.3.配置kube-scheduler service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1%E6%89%80%E6%9C%89master%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE%EF%BC%8C%E4%B8%94%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%90%8C"><span class="toc-number">6.3.1.</span> <span class="toc-text">6.3.1所有master节点配置，且配置相同</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-number">6.3.2.</span> <span class="toc-text">6.3.2启动并查看服务状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-TLS-Bootstrapping%E9%85%8D%E7%BD%AE"><span class="toc-number">7.</span> <span class="toc-text">7.TLS Bootstrapping配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1%E5%9C%A8master01%E4%B8%8A%E9%85%8D%E7%BD%AE"><span class="toc-number">7.1.</span> <span class="toc-text">7.1在master01上配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%EF%BC%8C%E6%B2%A1%E9%97%AE%E9%A2%98%E7%9A%84%E8%AF%9D%E7%BB%A7%E7%BB%AD%E5%90%8E%E7%BB%AD%E6%93%8D%E4%BD%9C"><span class="toc-number">7.2.</span> <span class="toc-text">7.2查看集群状态，没问题的话继续后续操作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-node%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">8.node节点配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E5%9C%A8master01%E4%B8%8A%E5%B0%86%E8%AF%81%E4%B9%A6%E5%A4%8D%E5%88%B6%E5%88%B0node%E8%8A%82%E7%82%B9"><span class="toc-number">8.1.</span> <span class="toc-text">8.1.在master01上将证书复制到node节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-kubelet%E9%85%8D%E7%BD%AE"><span class="toc-number">8.2.</span> <span class="toc-text">8.2.kubelet配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1%E6%89%80%E6%9C%89k8s%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%85%B3%E7%9B%AE%E5%BD%95"><span class="toc-number">8.2.1.</span> <span class="toc-text">8.2.1所有k8s节点创建相关目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2%E6%89%80%E6%9C%89k8s%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BAkubelet%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">8.2.2.</span> <span class="toc-text">8.2.2所有k8s节点创建kubelet的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-3%E5%90%AF%E5%8A%A8kubelet"><span class="toc-number">8.2.3.</span> <span class="toc-text">8.2.3启动kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-4%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4"><span class="toc-number">8.2.4.</span> <span class="toc-text">8.2.4查看集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-kube-proxy%E9%85%8D%E7%BD%AE"><span class="toc-number">8.3.</span> <span class="toc-text">8.3.kube-proxy配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1%E6%AD%A4%E9%85%8D%E7%BD%AE%E5%8F%AA%E5%9C%A8master01%E6%93%8D%E4%BD%9C"><span class="toc-number">8.3.1.</span> <span class="toc-text">8.3.1此配置只在master01操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-2%E5%B0%86kubeconfig%E5%8F%91%E9%80%81%E8%87%B3%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9"><span class="toc-number">8.3.2.</span> <span class="toc-text">8.3.2将kubeconfig发送至其他节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-3%E6%89%80%E6%9C%89k8s%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0kube-proxy%E7%9A%84%E9%85%8D%E7%BD%AE%E5%92%8Cservice%E6%96%87%E4%BB%B6"><span class="toc-number">8.3.3.</span> <span class="toc-text">8.3.3所有k8s节点添加kube-proxy的配置和service文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-4%E5%90%AF%E5%8A%A8kube-proxy"><span class="toc-number">8.3.4.</span> <span class="toc-text">8.3.4启动kube-proxy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E5%AE%89%E8%A3%85Calico"><span class="toc-number">9.</span> <span class="toc-text">9.安装Calico</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1%E4%BB%A5%E4%B8%8B%E6%AD%A5%E9%AA%A4%E5%8F%AA%E5%9C%A8master01%E6%93%8D%E4%BD%9C"><span class="toc-number">9.1.</span> <span class="toc-text">9.1以下步骤只在master01操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-1%E6%9B%B4%E6%94%B9calico%E7%BD%91%E6%AE%B5"><span class="toc-number">9.1.1.</span> <span class="toc-text">9.1.1更改calico网段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-2%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81"><span class="toc-number">9.1.2.</span> <span class="toc-text">9.1.2查看容器状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E5%AE%89%E8%A3%85CoreDNS"><span class="toc-number">10.</span> <span class="toc-text">10.安装CoreDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1%E4%BB%A5%E4%B8%8B%E6%AD%A5%E9%AA%A4%E5%8F%AA%E5%9C%A8master01%E6%93%8D%E4%BD%9C"><span class="toc-number">10.1.</span> <span class="toc-text">10.1以下步骤只在master01操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-1%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6"><span class="toc-number">10.1.1.</span> <span class="toc-text">10.1.1修改文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-2%E5%AE%89%E8%A3%85"><span class="toc-number">10.1.2.</span> <span class="toc-text">10.1.2安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E5%AE%89%E8%A3%85Metrics-Server"><span class="toc-number">11.</span> <span class="toc-text">11.安装Metrics Server</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1%E4%BB%A5%E4%B8%8B%E6%AD%A5%E9%AA%A4%E5%8F%AA%E5%9C%A8master01%E6%93%8D%E4%BD%9C"><span class="toc-number">11.1.</span> <span class="toc-text">11.1以下步骤只在master01操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-1%E5%AE%89%E8%A3%85Metrics-server"><span class="toc-number">11.1.1.</span> <span class="toc-text">11.1.1安装Metrics-server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-2%E7%A8%8D%E7%AD%89%E7%89%87%E5%88%BB%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81"><span class="toc-number">11.1.2.</span> <span class="toc-text">11.1.2稍等片刻查看状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-%E9%9B%86%E7%BE%A4%E9%AA%8C%E8%AF%81"><span class="toc-number">12.</span> <span class="toc-text">12.集群验证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1%E9%83%A8%E7%BD%B2pod%E8%B5%84%E6%BA%90"><span class="toc-number">12.1.</span> <span class="toc-text">12.1部署pod资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2%E7%94%A8pod%E8%A7%A3%E6%9E%90%E9%BB%98%E8%AE%A4%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%AD%E7%9A%84kubernetes"><span class="toc-number">12.2.</span> <span class="toc-text">12.2用pod解析默认命名空间中的kubernetes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3%E6%B5%8B%E8%AF%95%E8%B7%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E8%A7%A3%E6%9E%90"><span class="toc-number">12.3.</span> <span class="toc-text">12.3测试跨命名空间是否可以解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-4%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E9%83%BD%E5%BF%85%E9%A1%BB%E8%A6%81%E8%83%BD%E8%AE%BF%E9%97%AEKubernetes%E7%9A%84kubernetes-svc-443%E5%92%8Ckube-dns%E7%9A%84service-53"><span class="toc-number">12.4.</span> <span class="toc-text">12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-5Pod%E5%92%8CPod%E4%B9%8B%E5%89%8D%E8%A6%81%E8%83%BD%E9%80%9A"><span class="toc-number">12.5.</span> <span class="toc-text">12.5Pod和Pod之前要能通</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-6%E5%88%9B%E5%BB%BA%E4%B8%89%E4%B8%AA%E5%89%AF%E6%9C%AC%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B03%E4%B8%AA%E5%89%AF%E6%9C%AC%E5%88%86%E5%B8%83%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E8%8A%82%E7%82%B9%E4%B8%8A%EF%BC%88%E7%94%A8%E5%AE%8C%E5%8F%AF%E4%BB%A5%E5%88%A0%E4%BA%86%EF%BC%89"><span class="toc-number">12.6.</span> <span class="toc-text">12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E5%AE%89%E8%A3%85dashboard"><span class="toc-number">13.</span> <span class="toc-text">13.安装dashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98%E7%94%A8%E6%88%B7"><span class="toc-number">13.1.</span> <span class="toc-text">13.1创建管理员用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2%E6%89%A7%E8%A1%8Cyaml%E6%96%87%E4%BB%B6"><span class="toc-number">13.2.</span> <span class="toc-text">13.2执行yaml文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3%E6%9B%B4%E6%94%B9dashboard%E7%9A%84svc%E4%B8%BANodePort%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%B7%B2%E6%98%AF%E8%AF%B7%E5%BF%BD%E7%95%A5"><span class="toc-number">13.3.</span> <span class="toc-text">13.3更改dashboard的svc为NodePort，如果已是请忽略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-4%E6%9F%A5%E7%9C%8B%E7%AB%AF%E5%8F%A3%E5%8F%B7"><span class="toc-number">13.4.</span> <span class="toc-text">13.4查看端口号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-5%E6%9F%A5%E7%9C%8Btoken"><span class="toc-number">13.5.</span> <span class="toc-text">13.5查看token</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-6%E7%99%BB%E5%BD%95dashboard"><span class="toc-number">13.6.</span> <span class="toc-text">13.6登录dashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">14.</span> <span class="toc-text">14.安装命令行自动补全功能</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95%EF%BC%9A"><span class="toc-number">15.</span> <span class="toc-text">附录：</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




</html>
